name: release

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  release-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Extract branch name
        shell: bash
        run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> "$GITHUB_OUTPUT"
        id: extract_branch

      - name: Checkout
        id: checkout
        uses: https://code.forgejo.org/actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ steps.extract_branch.outputs.branch }}
      - name: debug
        run: |
          echo "Branch extracted: ${{ steps.extract_branch.outputs.branch }}"
          echo "All branches:"
          git branch -a
          echo "Current commit:"
          git rev-parse HEAD
          echo "git tree:"
          git log --pretty=oneline --topo-order --graph --abbrev-commit
      - name: Generate release with changelog
        uses: ./actions/release-with-cog
